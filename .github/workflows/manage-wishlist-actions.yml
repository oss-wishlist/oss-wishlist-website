# Workflow for OSS Wishlist - Database-driven wishlist management
# Triggers when wishlists are approved in the database

name: Manage Wishlist Actions

on:
  # Trigger via repository_dispatch when wishlist is approved
  repository_dispatch:
    types: [wishlist-approved]
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      wishlist_id:
        description: 'Wishlist ID to process'
        required: true
        type: number

jobs:
  manage-wishlist:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write      # To create PRs in maintainer repos
      issues: write        # To comment on issues if needed
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Get wishlist details from database
        id: get-wishlist
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          node -e "
          const { Pool } = require('pg');
          const pool = new Pool({ 
            connectionString: process.env.DATABASE_URL,
            ssl: { rejectUnauthorized: false }
          });
          
          async function getWishlist() {
            const wishlistId = ${{ github.event.client_payload.wishlist_id || github.event.inputs.wishlist_id }};
            const result = await pool.query(
              'SELECT * FROM wishlists WHERE id = \$1 AND approved = TRUE',
              [wishlistId]
            );
            
            if (result.rows.length === 0) {
              console.log('::error::Wishlist not found or not approved');
              process.exit(1);
            }
            
            const wishlist = result.rows[0];
            
            // Output wishlist data for next steps
            console.log('::set-output name=repository_url::' + wishlist.repository_url);
            console.log('::set-output name=maintainer::' + wishlist.maintainer_username);
            console.log('::set-output name=funding_yml::' + (wishlist.funding_yml || 'false'));
            console.log('::set-output name=project_name::' + wishlist.project_name);
            
            await pool.end();
          }
          
          getWishlist().catch(console.error);
          "

      - name: Create FUNDING.yml PR if requested
        if: steps.get-wishlist.outputs.funding_yml == 'true'
        uses: oss-wishlist/create-funding-yml@v1
        with:
          github-token: ${{ secrets.WISHLIST_BOT_TOKEN }}
          repository-url: ${{ steps.get-wishlist.outputs.repository_url }}
          maintainer: ${{ steps.get-wishlist.outputs.maintainer }}
          project-name: ${{ steps.get-wishlist.outputs.project_name }}

      - name: Notify completion
        if: always()
        run: |
          echo "Wishlist actions completed for ID: ${{ github.event.client_payload.wishlist_id || github.event.inputs.wishlist_id }}"
