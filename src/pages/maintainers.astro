---
import Layout from '../components/Layout.astro';
import ServiceCard from '../components/ServiceCard.astro';
import YourWishlistsGrid from '../components/YourWishlistsGrid.tsx';
import { getCollection } from 'astro:content';
import { getBasePath } from '../lib/paths';

const services = await getCollection('services');
const maintainerServices = services.filter(service => 
  service.data.target_audience === 'maintainer' || service.data.target_audience === 'both'
);

// Get user from middleware
const user = Astro.locals.user;
const basePath = getBasePath();

// Handle authentication redirect server-side to prevent flash
if (!user) {
  const currentPath = Astro.url.pathname;
  const searchParams = Astro.url.search;
  
  // Strip the base path if it exists to get the relative path
  let relativePath = currentPath.startsWith(basePath.slice(0, -1)) 
    ? currentPath.slice(basePath.slice(0, -1).length)
    : currentPath;
  
  // Ensure relativePath starts with /
  if (relativePath && !relativePath.startsWith('/')) {
    relativePath = '/' + relativePath;
  }
  if (!relativePath) {
    relativePath = '/';
  }
  
  // Redirect to login page with return URL
  const fullReturnPath = relativePath + searchParams;
  const returnTo = encodeURIComponent(fullReturnPath);
  return Astro.redirect(`${basePath}login?returnTo=${returnTo}`);
}
---

<Layout title="Services for Open Source Maintainers - OSS Wishlist" description="Practitioner services to help open source maintainers scale projects, build communities, and create sustainable funding.">
  <!-- Hero Section -->
  <section class="bg-gray-50 py-12" id="hero-section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-5xl font-bold text-gray-900 mb-4" id="page-title">
          Your <span class="text-accent">Wishlists</span>
        </h1>
        <p class="text-gray-600 text-base" id="page-description">
          Manage your open source project wishlists. View, edit, or create new wishes below.
        </p>
      </div>
    </div>
  </section>

  <!-- Your Wishlists Grid Section -->
  <section id="your-wishlists-section" class="py-12 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <YourWishlistsGrid client:load user={user} />
      </div>
    </div>
  </section>

  <!-- Create New Wishlist CTA Section -->
  <section id="create-wishlist-cta" class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-3xl font-bold text-gray-900 mb-4">
          Create a New Wishlist
        </h2>
        <p class="text-gray-600 text-base mb-8">
          Need help with your open source project? Create a wishlist to connect with practitioners who can help.
        </p>
        <a 
          href={`${basePath}create-wishlist`}
          class="btn-sparkle inline-flex items-center"
        >
          <svg class="btn-sparkle-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span class="btn-sparkle-text">Create Your Wishlist</span>
          <div class="btn-sparkle-particles">
            <span class="btn-sparkle-particle"></span>
            <span class="btn-sparkle-particle"></span>
            <span class="btn-sparkle-particle"></span>
          </div>
        </a>
      </div>
    </div>
  </section>

</Layout>