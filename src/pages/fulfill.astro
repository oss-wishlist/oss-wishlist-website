---
import Layout from '../components/Layout.astro';
import { getCollection } from 'astro:content';
import { GITHUB_CONFIG } from '../config/github.js';
import { getPriceForService, formatPrice } from '../lib/pricing.js';
import { getBasePath } from '../lib/paths';
import { parseIssueForm } from '../lib/issue-form-parser.js';
import { getAllPractitioners } from '../lib/db';
import AuthenticatedForm from '../components/AuthenticatedForm.tsx';

export const prerender = false;

const basePath = getBasePath();
const GITHUB_TOKEN = import.meta.env.GITHUB_TOKEN;

// Get user from session - require authentication
const user = Astro.locals.user;

// Get practitioners for the dropdown
const practitioners = await getAllPractitioners();

// Get services for detailed display
const services = await getCollection('services');

// Create a lookup map for services by both title and slug
const servicesByKey: Record<string, any> = services.reduce((acc, service) => {
  if (service.data.title) acc[service.data.title] = service;
  if ((service as any).slug) acc[(service as any).slug] = service;
  return acc;
}, {} as Record<string, any>);

// Try to get URL parameters
const url = Astro.url;
let wishlistData = null;
let issueNumber = null;
let githubIssue = null;
let projectSize: 'small' | 'medium' | 'large' | null = null;

// Check for issue parameter (GitHub issue number)
issueNumber = url.searchParams.get('issue');

if (issueNumber) {
  // Fetch wishlist from database API
  try {
    const apiUrl = new URL(`${basePath}api/wishlist`, url.origin);
    apiUrl.searchParams.set('id', issueNumber);
    
    const response = await fetch(apiUrl.toString());
    
    if (response.ok) {
      const data = await response.json();
      const wishlist = data.wishlist;
      
      if (wishlist) {
        // Found in database - use this data
        const projectName = wishlist.projectName;
        projectSize = wishlist.projectSize as 'small' | 'medium' | 'large';
        
        wishlistData = {
          issueNumber: wishlist.id,
          projectName,
          repositoryUrl: wishlist.repositoryUrl,
          maintainer: wishlist.maintainerUsername,
          wishes: wishlist.wishes || [],
          services: wishlist.wishes || [],
          urgency: wishlist.urgency,
          technologies: wishlist.technologies || [],
          projectSize: wishlist.projectSize,
          additionalNotes: wishlist.additionalNotes,
          url: wishlist.wishlistUrl,
          openToSponsorship: wishlist.openToSponsorship,
          preferredPractitioner: wishlist.preferredPractitioner || null,
          nomineeName: wishlist.nomineeName || null,
          nomineeEmail: wishlist.nomineeEmail || null,
          nomineeGithub: wishlist.nomineeGithub || null
        };
        
        // Also set githubIssue for compatibility
        githubIssue = {
          number: wishlist.id,
          title: `Wishlist: ${projectName}`,
          html_url: wishlist.wishlistUrl,
          user: {
            login: wishlist.maintainerUsername,
            // Use local logo to avoid cross-site cookie errors with GitHub images
            avatar_url: '/images/oss-wishlist-logo.jpg',
          },
        };
      }
    }
  } catch (error) {
    // Database fetch failed, will try GitHub fallback
  }
}

// Fallback to GitHub API if database lookup failed (shouldn't normally happen)
if (issueNumber && !wishlistData && GITHUB_TOKEN) {
  try {
    // Fetch the GitHub issue data
    const response = await fetch(
      `${GITHUB_CONFIG.API_ISSUES_URL}/${issueNumber}`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
        },
      }
    );

    if (response.ok) {
      githubIssue = await response.json();
      
      // Parse the issue body using the same parser as the API
      const parsed = parseIssueForm(githubIssue.body || '');
      
      // Extract project name from parsed data or title
      const projectName = parsed.project || githubIssue.title.replace(/^Wishlist:\s*/i, '').trim();
      
      // Set project size from parsed data
      if (parsed.projectSize) {
        projectSize = parsed.projectSize;
      }
      
      wishlistData = {
        issueNumber: githubIssue.number,
        projectName: projectName,
        wishes: parsed.services,  // Use parsed services instead of manual parsing
        url: githubIssue.html_url,
        maintainer: githubIssue.user.login,
        openToSponsorship: parsed.openToSponsorship,
        preferredPractitioner: parsed.preferredPractitioner || null,
        nomineeName: parsed.nomineeName || null,
        nomineeEmail: parsed.nomineeEmail || null,
        nomineeGithub: parsed.nomineeGithub || null
      };
    }
  } catch (error) {
    console.error('Error fetching GitHub issue:', error);
  }
}
---

<Layout title="Fulfill a Wishlist">
  <!-- Hero Section -->
  <section class="py-16 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-6">
          <span class="text-accent">Fulfill</span> an Open Source Wishlist
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Thank you for your interest in supporting open source projects. Please fill out this form to begin the fulfillment process for a wishlist.
        </p>
      </div>

      <!-- Form Section -->
      <div class="bg-white rounded-lg shadow-sm border p-8">
        <form class="space-y-6" method="POST" action={`${basePath}api/fulfill-wishlist`}>
          <!-- Wishlist Selection -->
          <div>
            <label for="wishlist" class="block text-sm font-medium text-gray-700 mb-2">
              Wishlist to Fulfill:
            </label>
            {wishlistData ? (
              <>
                <input 
                  type="text" 
                  id="wishlist" 
                  name="wishlist-display" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 bg-gray-50"
                  value={wishlistData.projectName}
                  readonly
                />
                <input type="hidden" name="issue-number" value={wishlistData.issueNumber} />
                <input type="hidden" name="project-name" value={wishlistData.projectName} />
                <input type="hidden" name="github-url" value={wishlistData.url} />
                <input type="hidden" name="maintainer" value={wishlistData.maintainer} />
                <input type="hidden" name="project-size" value={(projectSize || 'medium')} />
              </>
            ) : (
              <div class="alert-error">
                <div class="flex items-start gap-3">
                  <svg class="h-5 w-5 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                  <div>
                    <h3 class="font-semibold mb-2">
                      Invalid Access
                    </h3>
                    <p class="mb-2">This page can only be accessed by clicking "Fulfill This Wish" from a specific wishlist.</p>
                    <p>
                      <a href={`${basePath}wishlists`} class="font-medium underline hover:opacity-80">
                        Go to Wishlists page to select a wishlist to fulfill
                      </a>
                    </p>
                  </div>
                </div>
              </div>
            )}
          </div>

          <!-- How to Select Practitioners Info Box -->
          {wishlistData && (
            <div class="alert-info">
              <h3 class="font-semibold mb-2 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Selecting Practitioners
              </h3>
              <p class="text-sm mb-3">
                For each service, you can choose from approved practitioners who specialize in that service, or select "No preference" and we'll match you with the best practitioner.
              </p>
              <div class="flex flex-wrap gap-3 text-sm">
                <a href={`${basePath}practitioners`} target="_blank" rel="noopener noreferrer" class="underline hover:opacity-80 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  Browse all practitioners
                </a>
                <a href={`${basePath}faq#practitioner-matching-preferences`} target="_blank" rel="noopener noreferrer" class="underline hover:opacity-80 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  How matching works
                </a>
              </div>
              <p class="text-xs mt-3 text-gray-600">
                <strong>Want to nominate someone?</strong> If the maintainer knows someone qualified who isn't yet a listed practitioner, they can nominate them when creating their wishlist. Nominees are vetted before approval.
              </p>
            </div>
          )}

          <!-- Maintainer's Practitioner Preferences (if any) -->
          {wishlistData && (wishlistData.preferredPractitioner || wishlistData.nomineeName) && (
            <div class="alert-info">
              <h3 class="font-semibold mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Maintainer's Practitioner Preferences
              </h3>
              <p class="mb-3">
                The maintainer has expressed the following preferences. These will be considered alongside your selection when finalizing the match.{' '}
                <a href={`${basePath}faq#practitioner-matching-preferences`} target="_blank" rel="noopener noreferrer" class="underline hover:opacity-80">
                  Learn more
                </a>
              </p>
              
              {wishlistData.preferredPractitioner && (
                <div class="mb-3">
                  <p class="text-xs font-medium mb-1">Preferred Practitioner:</p>
                  <p class="text-sm">
                    {(() => {
                      // Try to find the practitioner in our collection
                      const practitioner = practitioners.find(p => p.github_username === wishlistData.preferredPractitioner);
                      return practitioner ? (
                        <>
                          <strong>{practitioner.name}</strong>
                          {practitioner.github_username && ` (@${practitioner.github_username})`}
                          {practitioner.title && ` — ${practitioner.title}`}
                        </>
                      ) : (
                        wishlistData.preferredPractitioner
                      );
                    })()}
                  </p>
                </div>
              )}
              
              {wishlistData.nomineeName && (
                <div>
                  <p class="text-xs font-medium mb-1">Nominated Practitioner:</p>
                  <p class="text-sm">
                    <strong>{wishlistData.nomineeName}</strong>
                  </p>
                  {(wishlistData.nomineeEmail || wishlistData.nomineeGithub) && (
                    <p class="text-xs mt-1">
                      {wishlistData.nomineeEmail && `Email: ${wishlistData.nomineeEmail}`}
                      {wishlistData.nomineeEmail && wishlistData.nomineeGithub && ' • '}
                      {wishlistData.nomineeGithub && `GitHub: ${wishlistData.nomineeGithub}`}
                    </p>
                  )}
                  <p class="text-xs mt-1 italic opacity-75">
                    Note: Nominees must be vetted and approved before they can fulfill wishes.
                  </p>
                </div>
              )}
            </div>
          )}

          <!-- Items to Fund (Wishes) -->
          {wishlistData && wishlistData.wishes && wishlistData.wishes.length > 0 && (
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Which services would you like to fund? <span class="field-required">*</span>
              </label>
              <p class="text-xs text-gray-500 mb-4">Select the services you want to sponsor and choose a practitioner for each (or let us select the best match).</p>
              <div class="space-y-4">
                {wishlistData.wishes.map((serviceName: string) => {
                  const serviceDetails = servicesByKey[serviceName] || servicesByKey[serviceName.split(' (')[0]?.trim()] || null;
                  
                  const sizeForPricing = projectSize || 'medium';
                  const price = serviceDetails && getPriceForService(serviceDetails.slug, sizeForPricing, services);
                  const priceText = price ? formatPrice(price) : 'Custom pricing';
                  
                  const serviceSlug = serviceDetails?.slug || serviceName.toLowerCase().replace(/\s+/g, '-');
                  
                  // Filter practitioners who offer this service
                  const availablePractitioners = practitioners.filter(p => 
                    p.services && p.services.includes(serviceSlug)
                  );

                  return (
                    <div key={serviceName} class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                      <div class="flex items-start gap-3">
                        <input 
                          type="checkbox" 
                          id={`service-${serviceName.replace(/\s+/g, '-').toLowerCase()}`}
                          name="services-to-fund"
                          value={serviceName}
                          data-service-slug={serviceSlug}
                          class="mt-1 mr-3 h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded funded-service-checkbox"
                          checked
                        />
                        <input 
                          type="hidden"
                          name="funded-slugs"
                          value={serviceSlug}
                          class="funded-service-slug"
                          data-service={serviceSlug}
                        />
                        <div class="flex-1">
                          <label 
                            for={`service-${serviceName.replace(/\s+/g, '-').toLowerCase()}`}
                            class="block text-sm font-medium text-gray-900 cursor-pointer"
                          >
                            {serviceName}
                          </label>
                          {serviceDetails && (
                            <div class="mt-2 space-y-1">
                              <p class="text-sm text-gray-600">
                                {serviceDetails.data.description}
                              </p>
                              {projectSize && (
                                <div class="text-xs text-gray-500">
                                  <strong>Project size:</strong>{' '}
                                  {projectSize.charAt(0).toUpperCase() + projectSize.slice(1)}
                                </div>
                              )}
                            </div>
                          )}
                          
                          <!-- Per-service practitioner selection -->
                          <div class="mt-3 pl-4 border-l-2 border-gray-300">
                            <label class="block text-xs font-medium text-gray-700 mb-2">
                              Practitioner for this service:
                            </label>
                            {availablePractitioners.length > 0 ? (
                              <select 
                                name={`practitioner-${serviceSlug}`}
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                              >
                                <option value="no-preference">No preference (we'll select best match)</option>
                                <option value="provide-own">We will use our own employee practitioner</option>
                                <optgroup label="Available Practitioners">
                                  {availablePractitioners.map(practitioner => (
                                    <option value={practitioner.github_username}>
                                      {practitioner.name} - {practitioner.title}
                                    </option>
                                  ))}
                                </optgroup>
                              </select>
                            ) : (
                              <div class="space-y-2">
                                <select 
                                  name={`practitioner-${serviceSlug}`}
                                  class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md bg-gray-100 text-gray-500"
                                  disabled
                                  aria-disabled="true"
                                >
                                  <option>No currently available practitioners</option>
                                </select>
                                <div>
                                  <label class="inline-flex items-start gap-2 text-sm text-gray-700">
                                    <input 
                                      type="checkbox" 
                                      name={`use-employee-${serviceSlug}`} 
                                      class="use-employee-checkbox h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-gray-500" 
                                      data-service={serviceSlug}
                                    />
                                    <span>
                                      We will use our own employee practitioner to complete this OSS Wishlist service.
                                    </span>
                                  </label>
                                  <p class="text-xs text-gray-500 mt-1">We'll still guide and track the work through the OSS Wishlist process.</p>
                                </div>
                              </div>
                            )}
                            
                            <!-- Custom practitioner input (shown when "provide own" selected) -->
                            <div class="mt-2 custom-practitioner-input" style="display: none;" data-service={serviceSlug}>
                              <input 
                                type="text" 
                                name={`custom-practitioner-${serviceSlug}`}
                                placeholder="Practitioner name and contact information"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                              />
                            </div>
                          </div>
                        </div>
                        <div class="flex-shrink-0 text-right">
                          <div class="inline-flex items-center px-2 py-1 rounded bg-gray-100 text-gray-800 text-xs border border-gray-200" title={`Estimated price for ${sizeForPricing} project`}>
                            {priceText}
                          </div>
                          {!projectSize && (
                            <div class="mt-1 text-[10px] text-gray-500">Assumes Medium size</div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          {wishlistData && (!wishlistData.wishes || wishlistData.wishes.length === 0) && (
            <div class="alert-info">
              <p class="mb-2"><strong>No Services Specified in Wishlist</strong></p>
              <p class="text-sm mb-3">
                This wishlist didn't include specific services when it was created. This is okay! You can still help the maintainer by selecting services you'd like to support below, or skip to the contact information section.
              </p>
              <details class="text-xs cursor-pointer">
                <summary class="font-semibold hover:opacity-80">Debug Info</summary>
                <div class="mt-2 bg-gray-50 p-2 rounded font-mono text-xs">
                  Issue Number: {wishlistData.issueNumber}<br/>
                  Wishes array: {JSON.stringify(wishlistData.wishes)}<br/>
                  Wishes length: {wishlistData.wishes?.length || 0}
                </div>
              </details>
            </div>
          )}

          <!-- Optional Services Section (when no services specified in wishlist) -->
          {wishlistData && (!wishlistData.wishes || wishlistData.wishes.length === 0) && (
            <div class="bg-white p-6 rounded-lg shadow-sm border">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Optional: Select Services to Support <span class="text-gray-500 text-xs">(Optional)</span>
              </label>
              <p class="text-xs text-gray-500 mb-4">Since no specific services were requested, you can optionally select any of our services you'd like to support for this project.</p>
              <div class="space-y-2">
                {services.map(service => (
                  <label key={service.slug} class="flex items-start gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input 
                      type="checkbox" 
                      name="optional-services"
                      value={service.data.title}
                      data-service-slug={service.slug}
                      class="mt-1 h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded optional-service-checkbox"
                    />
                    <div class="flex-1">
                      <div class="text-sm font-medium text-gray-900">{service.data.title}</div>
                      <div class="text-xs text-gray-600">{service.data.description}</div>
                    </div>
                  </label>
                ))}
              </div>
            </div>
          )}

          <!-- Additional Items -->
          <div>
            <label for="additional-items" class="block text-sm font-medium text-gray-600 mb-2">
              Additional items or notes (optional):
            </label>
            <textarea 
              id="additional-items" 
              name="additional-items" 
              rows="3" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
              placeholder="Any additional items, requirements, or special notes..."
            ></textarea>
          </div>

          <!-- Process Agreement for custom practitioners -->
          <div class="bg-gray-50 border border-gray-300 p-4 rounded-md" id="custom-practitioner-agreement" style="display: none;">
            <div class="flex items-start">
              <input 
                type="checkbox" 
                id="process-agreement" 
                name="process-agreement" 
                class="mt-1 mr-3"
              />
              <label for="process-agreement" class="text-sm text-gray-700">
                <strong>Process Agreement:</strong> I confirm our employee practitioner will complete the OSS Wishlist service using the OSS Wishlist process. This includes regular progress updates, adherence to project timelines, and a completion report upon delivery.
              </label>
            </div>
          </div>

          <!-- Timeline -->
          <div>
            <label for="timeline" class="block text-sm font-medium text-gray-600 mb-2">
              Proposed Timeline (optional)
            </label>
            <input 
              type="text" 
              id="timeline" 
              name="timeline" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
              placeholder="e.g., 3 months, Q2 2024, etc."
            />
          </div>

          <!-- Optional Honorarium (only show if maintainer opted in) -->
          {wishlistData && wishlistData.openToSponsorship && (
            <div class="alert-info">
              <div class="flex items-start">
                <input 
                  type="checkbox" 
                  id="include-sponsorship" 
                  name="include-sponsorship"
                  value="yes"
                  class="mt-1 h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-gray-500"
                />
                <div class="ml-3">
                  <label for="include-sponsorship" class="block text-sm font-medium text-gray-900">
                    I would like to provide a one-time honorarium to the maintainer
                  </label>
                  <p class="text-xs text-gray-600 mt-1">
                    An honorarium recognizes the maintainer's time and collaboration during wish fulfillment. This is not payment for services or an obligation, but a gesture of appreciation.
                  </p>
                </div>
              </div>
            </div>
          )}

          <!-- Contact Information -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="contact-person" class="block text-sm font-medium text-gray-700 mb-2">
                Contact Person <span class="field-required">*</span>
              </label>
              <input 
                type="text" 
                id="contact-person" 
                name="contact-person" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                required
              />
            </div>
            
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                Email Address <span class="field-required">*</span>
              </label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                required
              />
            </div>
          </div>

          <!-- Company -->
          <div>
            <label for="company" class="block text-sm font-medium text-gray-700 mb-2">
              Company/Organization <span class="field-required">*</span>
            </label>
            <input 
              type="text" 
              id="company" 
              name="company" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
              required
            />
          </div>

          <!-- Reason for Fulfillment -->
          <div>
            <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
              Reason for Fulfillment <span class="field-required">*</span>
            </label>
            <textarea 
              id="reason" 
              name="reason" 
              rows="4" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
              placeholder="Please describe why you want to fulfill this wishlist and how it aligns with your goals..."
              required
            ></textarea>
          </div>

          <!-- Submit Button -->
          {wishlistData && (
            <div class="pt-6">
              <button 
                type="submit" 
                class="btn-sparkle w-full"
              >
                <svg class="btn-sparkle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m0 0l-2-1m2 1v2.5M14 4l-2 1m0 0l-2-1m2 1v2.5" />
                </svg>
                <span class="btn-sparkle-text">Submit Fulfillment Request</span>
                <div class="btn-sparkle-particles">
                  <span class="sparkle-particle" style="top: 50%; left: 25%; background-color: rgb(196, 181, 253);"></span>
                  <span class="sparkle-particle" style="top: 25%; right: 33%; background-color: rgb(167, 139, 250); animation-delay: 0.1s;"></span>
                  <span class="sparkle-particle" style="bottom: 33%; right: 25%; background-color: rgb(217, 213, 254); animation-delay: 0.2s;"></span>
                </div>
              </button>
            </div>
          )}
        </form>
      </div>
    </div>
  </section>

  <script define:vars={{ 
    practitionerData: practitioners.reduce((acc, practitioner) => {
      acc[practitioner.github_username] = {
        name: practitioner.name,
        title: practitioner.title,
        bio: practitioner.bio,
        specialties: [], // Not in database schema
        location: practitioner.location || 'Not specified',
        languages: practitioner.languages || []
      };
      return acc;
    }, {})
  }}>
    // Handle per-service practitioner selection
    const practitionerSelects = document.querySelectorAll('select[name^="practitioner-"]');
    const customPractitionerAgreement = document.getElementById('custom-practitioner-agreement');
    const processAgreementCheckbox = document.getElementById('process-agreement');
    const useEmployeeCheckboxes = document.querySelectorAll('.use-employee-checkbox');
    const fundedServiceCheckboxes = document.querySelectorAll('.funded-service-checkbox');
    
    // Keep hidden funded service slug inputs in sync with checkboxes
    fundedServiceCheckboxes.forEach(cb => {
      cb.addEventListener('change', function() {
        const slug = this.getAttribute('data-service-slug');
        if (!slug) return;
        const hidden = document.querySelector(`input.funded-service-slug[data-service="${slug}"]`) as HTMLInputElement | null;
        if (!hidden) return;
        hidden.disabled = !this.checked;
      });
    });
    
    // Show/hide custom practitioner input based on selection
    practitionerSelects.forEach(select => {
      select.addEventListener('change', function() {
        const serviceSlug = this.name.replace('practitioner-', '');
        const customInput = document.querySelector(`.custom-practitioner-input[data-service="${serviceSlug}"]`);
        
        if (this.value === 'provide-own') {
          customInput.style.display = 'block';
          customInput.querySelector('input').required = true;
        } else {
          customInput.style.display = 'none';
          customInput.querySelector('input').required = false;
        }
        
        // Show/hide process agreement if any service has "provide-own" selected
        updateProcessAgreementVisibility();
      });
    });
    
    function updateProcessAgreementVisibility() {
      const hasCustomPractitioner = (
        Array.from(practitionerSelects).some(select => select.value === 'provide-own') ||
        Array.from(useEmployeeCheckboxes).some(cb => cb.checked)
      );
      
      if (hasCustomPractitioner) {
        customPractitionerAgreement.style.display = 'block';
        processAgreementCheckbox.required = true;
      } else {
        customPractitionerAgreement.style.display = 'none';
        processAgreementCheckbox.required = false;
      }
    }

    // Field validation helpers
    const fieldErrors = {};
    
    function clearFieldError(fieldName) {
      const field = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
      if (field) {
        field.classList.remove('border-gray-700', 'border-2');
        field.classList.add('border-gray-300');
      }
      const errorMsg = field?.parentElement?.querySelector('.field-error-message');
      if (errorMsg) errorMsg.remove();
      delete fieldErrors[fieldName];
    }
    
    function highlightInvalidField(fieldName, message = 'This field is required') {
      const field = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
      if (field) {
        field.classList.remove('border-gray-300');
        field.classList.add('border-gray-700', 'border-2');
        
        const parent = field.parentElement;
        if (parent && !parent.querySelector('.field-error-message')) {
          const errorMsg = document.createElement('p');
          errorMsg.className = 'field-error-message text-gray-700 text-sm mt-1';
          errorMsg.textContent = message;
          parent.appendChild(errorMsg);
        }
        fieldErrors[fieldName] = message;
      }
    }

    // Add input listeners to clear errors
    const allInputs = document.querySelectorAll('input, select, textarea');
    allInputs.forEach(input => {
      input.addEventListener('input', function() {
        clearFieldError(this.name || this.id);
      });
    });

    // Handle per-service "use employee" checkbox toggling
    useEmployeeCheckboxes.forEach(cb => {
      cb.addEventListener('change', function() {
        const serviceSlug = this.dataset.service;
        const customInput = document.querySelector(`.custom-practitioner-input[data-service="${serviceSlug}"]`);
        if (!customInput) return;
        
        if (this.checked) {
          customInput.style.display = 'block';
          const input = customInput.querySelector('input');
          if (input) input.required = true;
        } else {
          customInput.style.display = 'none';
          const input = customInput.querySelector('input');
          if (input) input.required = false;
        }
        updateProcessAgreementVisibility();
      });
    });

    // Form validation to ensure at least one service is selected (if checkboxes are present)
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
      // Add loading state to submit button
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        const originalText = submitButton.innerHTML;
        submitButton.disabled = true;
        
        // Safe: Create loading state with DOM methods
        submitButton.textContent = '';
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'btn-sparkle-icon animate-spin');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('aria-hidden', 'true');
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('class', 'opacity-25');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        circle.setAttribute('stroke', 'currentColor');
        circle.setAttribute('stroke-width', '4');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'opacity-75');
        path.setAttribute('fill', 'currentColor');
        path.setAttribute('d', 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z');
        svg.appendChild(circle);
        svg.appendChild(path);
        
        const loadingText = document.createElement('span');
        loadingText.className = 'btn-sparkle-text';
        loadingText.textContent = 'Submitting...';
        
        submitButton.appendChild(svg);
        submitButton.appendChild(loadingText);
        
        // Re-enable button after 5 seconds if form validation fails
        setTimeout(() => {
          if (!form.classList.contains('submitting')) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
          }
        }, 5000);
      }
      
      // Clear previous errors
      Object.keys(fieldErrors).forEach(clearFieldError);
      let hasErrors = false;
      
      const serviceCheckboxes = document.querySelectorAll('.funded-service-checkbox');
      
      if (serviceCheckboxes.length > 0) {
        const checkedServices = document.querySelectorAll('.funded-service-checkbox:checked');
        if (checkedServices.length === 0) {
          e.preventDefault();
          highlightInvalidField('services-section', 'Please select at least one wish from the wishlist to fulfill.');
          hasErrors = true;
        }
      }
      
      // Validate required fields
      const requiredFields = [
        { name: 'contact-person', message: 'Contact person name is required' },
        { name: 'email', message: 'Email address is required' },
        { name: 'reason', message: 'Please provide a reason for fulfillment' }
      ];
      
      requiredFields.forEach(({ name, message }) => {
        const field = document.querySelector(`[name="${name}"]`);
        if (field && !field.value.trim()) {
          highlightInvalidField(name, message);
          hasErrors = true;
        }
      });
      
      if (hasErrors) {
        e.preventDefault();
        // Scroll to first error
        const firstError = document.querySelector('.border-gray-700');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => firstError.focus(), 500);
        }
        return false;
      }
    });
  </script>
  </AuthenticatedForm>
</Layout>