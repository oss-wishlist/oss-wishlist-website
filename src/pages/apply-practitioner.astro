---
import { getBasePath } from '../lib/paths';
const basePath = getBasePath();
import Layout from '../components/Layout.astro';
import AuthenticatedForm from '../components/AuthenticatedForm.tsx';
import { getCollection } from 'astro:content';

// Get user from session
const user = Astro.locals.user;

// Get all services from the catalog (exclude resources)
const allServices = await getCollection('services');
const services = allServices.filter(s => s.data.type === 'service');
const serviceCategories = [...new Set(services.map(s => s.data.service_category || 'Other'))].sort();
---

<Layout title="Apply to be an Practitioner - OSS Wishlist" description="Join our community of verified open source practitioners. Help projects succeed while building your professional network.">
  <AuthenticatedForm client:load user={user} formType="practitioner application">
    <section class="py-16 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-6">
          Sign up as an Open Source <span class="text-accent">Practitioner</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Help open source projects thrive by offering your verified expertise. 
          Connect with maintainers who need your skills.
        </p>
      </div>

    <!-- Application Form -->
    <div class="bg-white rounded-lg shadow-sm border p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Practitioner Application</h2>
      
      <form id="practitionerApplicationForm" class="space-y-6">
        <!-- Error box -->
        <div id="formError" class="alert-error hidden" role="alert" aria-live="polite"></div>
        <!-- Personal Information -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
            <input 
              type="text" 
              id="fullName" 
              name="fullName" 
              required 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="Your full name"
            />
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="your@email.com"
            />
          </div>
        </div>

        <!-- Professional Info -->
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Professional Title *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            required 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
            placeholder="e.g., Senior Software Engineer, Community Manager, Security Consultant"
          />
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="company" class="block text-sm font-medium text-gray-700 mb-2">Current Company/Organization</label>
            <input 
              type="text" 
              id="company" 
              name="company" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="Your current employer or 'Independent'"
            />
          </div>
          <div>
            <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Location</label>
            <input 
              type="text" 
              id="location" 
              name="location" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="City, Country or Remote"
            />
          </div>
        </div>

        <!-- Languages -->
        <div>
          <label for="languages" class="block text-sm font-medium text-gray-700 mb-2">Languages Spoken * <span class="text-xs text-gray-500 font-normal">(comma-separated)</span></label>
          <input 
            type="text" 
            id="languages" 
            name="languages" 
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
            placeholder="English, Spanish, French"
          />
          <p class="text-xs text-gray-500 mt-1">List all languages you can work in, separated by commas</p>
        </div>

        <!-- Experience -->
        <div class="grid md:grid-cols-1 gap-6">
          <div>
            <label for="experience" class="block text-sm font-medium text-gray-700 mb-2">Years of Experience *</label>
            <select 
              id="experience" 
              name="experience" 
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500"
            >
              <option value="" disabled selected>Select experience level</option>
              <option value="0-2">0-2 years</option>
              <option value="2-5">2-5 years</option>
              <option value="5-8">5-8 years</option>
              <option value="8-12">8-12 years</option>
              <option value="12+">12+ years</option>
            </select>
          </div>
        </div>        <!-- Expertise Areas -->
        <div>
          <label for="specialties" class="block text-sm font-medium text-gray-700 mb-2">Areas of Expertise *</label>
          <p class="text-xs text-gray-500 mb-3">Select the services from our catalogue that match your expertise</p>
          <div class="grid md:grid-cols-2 gap-3 mb-3">
            {services.map((service) => (
              <label class="flex items-start" key={service.slug}>
                <input type="checkbox" name="specialties" value={service.data.title} class="mr-2 rounded mt-1" />
                <span class="text-sm">
                  <a href={`${basePath}services/${service.slug}`} target="_blank" class="text-gray-700 hover:text-gray-900 underline">
                    {service.data.title}
                  </a>
                  {service.data.service_category && (
                    <span class="text-xs text-gray-500 block">({service.data.service_category})</span>
                  )}
                </span>
              </label>
            ))}
          </div>
          <textarea 
            id="otherSpecialties" 
            name="otherSpecialties" 
            rows="2" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
            placeholder="Other specialties not listed above..."
          ></textarea>
        </div>

        <!-- Bio -->
        <div>
          <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">Professional Bio * <span class="text-xs text-gray-500 font-normal">(<span id="bioCharCount">0</span>/500)</span></label>
          <textarea 
            id="bio" 
            name="bio" 
            required 
            maxlength="500"
            rows="4" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
            placeholder="Tell us about your background, experience, and what makes you a great practitioner for our network (2-3 sentences, max 500 characters)..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">Maximum 500 characters</p>
        </div>

        <!-- Social/Contact -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="github" class="block text-sm font-medium text-gray-700 mb-2">GitHub Username *</label>
            <input 
              type="text" 
              id="github" 
              name="github" 
              required
              readonly
              value={user?.login || ''}
              class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed" 
              placeholder="Automatically filled from your GitHub account"
            />
            <p class="mt-1 text-sm text-gray-500">This is automatically set to your authenticated GitHub username</p>
          </div>
          <div>
            <label for="linkedin" class="block text-sm font-medium text-gray-700 mb-2">LinkedIn Profile URL</label>
            <input 
              type="url" 
              id="linkedin" 
              name="linkedin" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="https://linkedin.com/in/yourprofile"
            />
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="mastodon" class="block text-sm font-medium text-gray-700 mb-2">Mastodon Profile URL</label>
            <input 
              type="url" 
              id="mastodon" 
              name="mastodon" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="https://mastodon.social/@yourusername"
            />
          </div>
          <div>
            <label for="website" class="block text-sm font-medium text-gray-700 mb-2">Website/Portfolio URL</label>
            <input 
              type="url" 
              id="website" 
              name="website" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
              placeholder="https://yourwebsite.com"
            />
          </div>
        </div>

        <!-- Notable Projects -->
        <div>
          <label for="projects" class="block text-sm font-medium text-gray-700 mb-2">Notable Open Source Projects</label>
          <textarea 
            id="projects" 
            name="projects" 
            rows="3" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
            placeholder="List notable open source projects you've contributed to, maintained, or founded..."
          ></textarea>
        </div>

        <!-- Availability -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="availability" class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
            <select 
              id="availability" 
              name="availability" 
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500"
            >
              <option value="available">Available</option>
              <option value="limited">Limited availability</option>
              <option value="unavailable">Not currently available</option>
            </select>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="proBono" name="proBono" class="mr-2 rounded">
            <label for="proBono" class="text-sm text-gray-700">I accept pro bono cases in some situations</label>
          </div>
          
          <!-- Pro Bono Criteria - conditionally shown -->
          <div id="proBonoCriteria" class="mt-4 hidden space-y-4">
            <div>
              <label for="proBonoHours" class="block text-sm font-medium text-gray-700 mb-2">
                Pro Bono Hours Per Month *
              </label>
              <input 
                type="number" 
                id="proBonoHours" 
                name="proBonoHours" 
                min="1" 
                max="10"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
                placeholder="e.g., 5"
              />
              <p class="text-xs text-gray-500 mt-1">How many hours per month can you dedicate to pro bono work?</p>
            </div>
            
            <div>
              <label for="proBonoCriteriaText" class="block text-sm font-medium text-gray-700 mb-2">Pro Bono Criteria</label>
              <textarea 
                id="proBonoCriteriaText" 
                name="proBonoCriteriaText" 
                rows="3" 
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                placeholder="Please describe the criteria for cases where you would accept pro bono work (e.g., non-profit organizations, solo maintainers, specific project types, etc.)"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Additional Info -->
        <div>
          <label for="additionalInfo" class="block text-sm font-medium text-gray-700 mb-2">Additional Information</label>
          <textarea 
            id="additionalInfo" 
            name="additionalInfo" 
            rows="3" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" 
            placeholder="Anything else you'd like us to know? Certifications, languages, preferred project types, etc."
          ></textarea>
        </div>

        <!-- Submit Button -->
        <div class="text-center pt-6">
          <button 
            id="practitioner-submit-btn"
            type="submit"
            class="bg-gray-900 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 mx-auto"
          >
            <span id="btn-text">Submit Practitioner Application</span>
          </button>
        </div>

        <div class="text-sm text-gray-600 text-center">
          <p>By submitting this form, you agree to be contacted about joining our practitioner network. We'll review your application and get back to you within 5-7 business days.</p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Base path for client-side routes - ensure it ends with /
  const baseUrl = import.meta.env.BASE_URL || '/';
  const basePath = baseUrl.endsWith('/') ? baseUrl : `${baseUrl}/`;

    // Clear all field errors
    function clearFieldErrors() {
      const fields = document.querySelectorAll('.border-gray-700');
      fields.forEach(field => {
        field.classList.remove('border-gray-700', 'border-2');
        field.classList.add('border-gray-300');
      });
      const errorMessages = document.querySelectorAll('.field-error-message');
      errorMessages.forEach(msg => msg.remove());
    }

    // Highlight invalid fields
    function highlightInvalidFields(fields) {
      if (!fields || !Array.isArray(fields)) return;
      
      fields.forEach(fieldName => {
        const field = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
        if (field) {
          field.classList.remove('border-gray-300');
          field.classList.add('border-gray-700', 'border-2');
          
          // Add error message if not already present
          const parent = field.parentElement;
          if (parent && !parent.querySelector('.field-error-message')) {
            const errorMsg = document.createElement('p');
            errorMsg.className = 'field-error-message text-gray-700 text-sm mt-1';
            errorMsg.textContent = 'This field is required';
            parent.appendChild(errorMsg);
          }
          
          // Scroll to first invalid field
          if (fields[0] === fieldName) {
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => field.focus(), 500);
          }
        }
      });
    }

    // Handle pro bono criteria visibility
    document.addEventListener('DOMContentLoaded', function() {
      const proBonoCheckbox = document.getElementById('proBono');
      const proBonoCriteriaDiv = document.getElementById('proBonoCriteria');
      const proBonoHoursInput = document.getElementById('proBonoHours');
      
      // Bio character counter
      const bioTextarea = document.getElementById('bio');
      const bioCharCount = document.getElementById('bioCharCount');
      
      if (bioTextarea && bioCharCount) {
        bioTextarea.addEventListener('input', function() {
          bioCharCount.textContent = this.value.length;
        });
      }
      
      proBonoCheckbox.addEventListener('change', function() {
        if (this.checked) {
          proBonoCriteriaDiv.classList.remove('hidden');
          // Make pro bono capacity required when checked
          proBonoHoursInput.setAttribute('required', 'required');
        } else {
          proBonoCriteriaDiv.classList.add('hidden');
          document.getElementById('proBonoCriteriaText').value = '';
          proBonoHoursInput.value = '';
          // Remove required attribute when unchecked
          proBonoHoursInput.removeAttribute('required');
        }
      });

      // Clear errors on input change
      const form = document.getElementById('practitionerApplicationForm');
      if (form) {
        form.addEventListener('input', clearFieldErrors);
      }
    });

    // Handle form submission
    document.getElementById('practitionerApplicationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Add loading state to button
      const submitBtn = document.getElementById('practitioner-submit-btn');
      const btnText = document.getElementById('btn-text');
      const originalText = btnText.textContent;
      
      submitBtn.disabled = true;
      btnText.textContent = '';
      const spinner = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      spinner.setAttribute('class', 'animate-spin h-4 w-4 inline mr-2');
      spinner.setAttribute('fill', 'none');
      spinner.setAttribute('viewBox', '0 0 24 24');
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('class', 'opacity-25');
      circle.setAttribute('cx', '12');
      circle.setAttribute('cy', '12');
      circle.setAttribute('r', '10');
      circle.setAttribute('stroke', 'currentColor');
      circle.setAttribute('stroke-width', '4');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('class', 'opacity-75');
      path.setAttribute('fill', 'currentColor');
      path.setAttribute('d', 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z');
      spinner.appendChild(circle);
      spinner.appendChild(path);
      const loadingText = document.createElement('span');
      loadingText.textContent = 'Submitting...';
      btnText.appendChild(spinner);
      btnText.appendChild(loadingText);
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      // Collect selected specialties
      const specialties = Array.from(document.querySelectorAll('input[name="specialties"]:checked'))
        .map(cb => cb.value);
      data.specialties = specialties;
      
      // Parse languages from comma-separated string
      const languages = data.languages 
        ? data.languages.split(',').map(lang => lang.trim()).filter(lang => lang.length > 0)
        : ['English']; // Default to English if not provided
      
      try {
        // Clear previous errors
        const errorBox = document.getElementById('formError');
        if (errorBox) {
          errorBox.classList.add('hidden');
          // Safe: Clear content with textContent
          errorBox.textContent = '';
        }
        clearFieldErrors();

        const payload = {
          fullName: data.fullName,
          email: data.email,
          title: data.title,
          company: data.company,
          location: data.location,
          languages: languages,
          experience: data.experience,
          specialties: specialties,
          otherSpecialties: data.otherSpecialties,
          bio: data.bio,
          github: data.github,
          linkedin: data.linkedin,
          mastodon: data.mastodon,
          website: data.website,
          projects: data.projects,
          availability: data.availability,
          proBono: data.proBono,
          proBonoHours: data.proBonoHours,
          proBonoCriteriaText: data.proBonoCriteriaText,
          additionalInfo: data.additionalInfo
        };

  // Submit practitioner application via API

        const response = await fetch(`${basePath}api/submit-practitioner`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          await response.text();
          throw new Error('Server returned an invalid response. Please try again.');
        }
        
        const result = await response.json();

        if (response.ok && result.success) {
          // Redirect to success page
          window.location.href = `${basePath}practitioner-success`;
        } else {
          const errorBox = document.getElementById('formError');
          if (errorBox) {
            errorBox.classList.remove('hidden');
            errorBox.innerHTML = '';
            const title = document.createElement('p');
            title.className = 'font-semibold mb-1';
            title.textContent = 'There was a problem submitting your application:';
            errorBox.appendChild(title);

            const msg = document.createElement('p');
            msg.textContent = result.error || 'Unknown error';
            errorBox.appendChild(msg);

            if (result.fields && Array.isArray(result.fields) && result.fields.length) {
              const list = document.createElement('ul');
              list.className = 'list-disc pl-5 mt-2';
              result.fields.forEach(f => {
                const li = document.createElement('li');
                li.textContent = `Missing: ${f}`;
                list.appendChild(li);
              });
              errorBox.appendChild(list);
              
              // Highlight invalid fields
              highlightInvalidFields(result.fields);
            }

            // Focus the error box for accessibility
            errorBox.setAttribute('tabindex', '-1');
            errorBox.focus();
          }
          // Reset button on error
          submitBtn.disabled = false;
          btnText.textContent = originalText;
          return; // Don't throw; we've handled UI
        }
      } catch (error) {
        console.error('[Practitioner Form] Caught error:', error);
        console.error('[Practitioner Form] Error type:', error.constructor.name);
        console.error('[Practitioner Form] Error message:', error instanceof Error ? error.message : String(error));
        
        const errorBox = document.getElementById('formError');
        if (errorBox) {
          errorBox.classList.remove('hidden');
          // Safe: Clear and rebuild with DOM methods
          errorBox.textContent = '';
          
          const title = document.createElement('p');
          title.className = 'font-semibold mb-1';
          title.textContent = 'Unexpected error';
          errorBox.appendChild(title);
          
          let errorMessage = 'Please try again or contact us directly.';
          
          if (error instanceof TypeError && error.message.includes('fetch')) {
            errorMessage += ' (Network error - please check your connection)';
          } else if (error instanceof Error) {
            errorMessage += ` (${error.message})`;
          }
          
          const msg = document.createElement('p');
          msg.textContent = errorMessage; // Safe: textContent escapes HTML
          errorBox.appendChild(msg);
          
          errorBox.setAttribute('tabindex', '-1');
          errorBox.focus();
        }
        // Reset button on error
        submitBtn.disabled = false;
        btnText.textContent = originalText;
      }
    });
  </script>
    </div>
    </section>
  </AuthenticatedForm>
</Layout>