---
import { getBasePath } from '../lib/paths';
import { getPractitionerByUsername } from '../lib/db';

// This is a standalone header component extracted from Layout.astro
// It contains the navigation menu with dropdowns for:
// - Browse Wishlists (top-level)
// - Services (top-level)
// - For Maintainers (dropdown: Manage Wishlists, View Your Profile [if exists])
// - Community (dropdown: Join Community, View Opportunities, Find Practitioners, Become Practitioner, Code of Conduct)
// - For Sponsors (dropdown: Browse Wishlists to Fund, Sponsor Directory, How Funding Works)
// - Resources (dropdown: How It Works, FAQ)
// - Auth Button

const basePath = getBasePath(); // Returns with trailing slash
const logoUrl = '/logo.png';
const user = Astro.locals.user;

// Check if the logged-in user has a practitioner profile (optimized query)
let userPractitionerSlug = null;
if (user?.login || user?.username) {
  const username = user.login || user.username;
  const userPractitioner = await getPractitionerByUsername(username);
  if (userPractitioner) {
    userPractitionerSlug = userPractitioner.github || userPractitioner.gitlab;
  }
}
---

<header class="bg-white shadow-sm border-b">
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" aria-label="Main navigation">
    <div class="flex justify-between items-center h-16 gap-2">
      <div class="flex items-center gap-2 min-w-0">
        <img src={logoUrl} alt="Open Source Wishlist logo" class="h-8 w-8 flex-shrink-0" />
        <a href={basePath} class="text-sm sm:text-xl font-bold text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded truncate">Open Source Wishlist</a>
      </div>
      
      <!-- Desktop Navigation -->
  <div class="hidden md:flex space-x-6 items-center">
        
        <!-- Wishlists Dropdown -->
        <div class="relative" id="wishlists-dropdown">
          <button 
            class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded px-2 py-1 flex items-center space-x-1 min-h-[44px]"
            aria-expanded="false"
            aria-haspopup="true"
            aria-label="Wishlists menu"
            id="wishlists-dropdown-button"
          >
            <span>Wishlists</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <div 
            id="wishlists-menu"
            class="absolute left-0 mt-2 w-64 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50"
            role="menu"
            aria-orientation="vertical"
            aria-labelledby="wishlists-dropdown-button"
          >
            <div class="py-1" role="none">
              <a href={`${basePath}catalog`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Wishlist Catalogue</a>
              <a href={`${basePath}wishlists`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">All Wishlists</a>
              <a href={`${basePath}maintainers`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">My Wishlists</a>
            </div>
          </div>
        </div>
        
        <!-- Helper Community Dropdown -->
        <div class="relative" id="helper-community-dropdown">
          <button 
            class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded px-2 py-1 flex items-center space-x-1 min-h-[44px]"
            aria-expanded="false"
            aria-haspopup="true"
            aria-label="Helper Community menu"
            id="helper-community-dropdown-button"
          >
            <span>Helper Community</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <div 
            id="helper-community-menu"
            class="absolute left-0 mt-2 w-64 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50"
            role="menu"
            aria-orientation="vertical"
            aria-labelledby="helper-community-dropdown-button"
          >
            <div class="py-1" role="none">
              <a href={`${basePath}helpers`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Helper Community Efforts</a>
              <a href={`${basePath}calendar`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Community Calendar</a>
              <a href={`${basePath}practitioners`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">OSS Practitioners</a>
              <a href={`${basePath}campaigns`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Current Campaigns</a>
              <a href={`${basePath}ai-alignment`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">AI Alignment for OSS</a>
              <a href={`${basePath}code-of-conduct`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Code of Conduct</a>
            </div>
          </div>
        </div>
        
        <!-- About Dropdown -->
        <div class="relative" id="about-dropdown">
          <button 
            class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded px-2 py-1 flex items-center space-x-1 min-h-[44px]"
            aria-expanded="false"
            aria-haspopup="true"
            aria-label="About menu"
            id="about-dropdown-button"
          >
            <span>About</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <div 
            id="about-menu"
            class="absolute left-0 mt-2 w-64 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50"
            role="menu"
            aria-orientation="vertical"
            aria-labelledby="about-dropdown-button"
          >
            <div class="py-1" role="none">
              <a href={`${basePath}about-us`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">About Us</a>
              <a href={`${basePath}faq`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">FAQ</a>
              <a href={`${basePath}terms`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Terms & Conditions</a>
              <div class="border-t my-1"></div>
              {user ? (
                <a href={`${basePath}api/auth/logout`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">
                  Logout of {user.provider === 'github' ? 'GitHub' : user.provider === 'gitlab' ? 'GitLab' : user.provider || 'Account'}
                </a>
              ) : (
                <a href={`${basePath}login`} class="wishlist-menu-item block px-4 py-2 text-sm text-gray-900 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none min-h-[44px] flex items-center transition-all relative" role="menuitem" tabindex="-1">Login</a>
              )}
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile menu button -->
      <button 
        id="mobile-menu-button" 
        class="md:hidden text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 rounded p-2"
        aria-expanded="false"
        aria-label="Toggle navigation menu"
        aria-controls="mobile-menu"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Navigation Menu -->
    <div id="mobile-menu" class="hidden md:hidden pb-4" role="navigation" aria-label="Mobile navigation">
      <div class="space-y-1">
        <a href={`${basePath}catalog`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">Wishlist Catalogue</a>
        <a href={`${basePath}wishlists`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">All Wishlists</a>
        <a href={`${basePath}maintainers`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">My Wishlists</a>
        <div class="border-t border-gray-200 my-2"></div>
        <a href={`${basePath}helpers`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">Helper Community Efforts</a>
        <a href={`${basePath}calendar`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">Community Calendar</a>
        <a href={`${basePath}practitioners`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">OSS Practitioners</a>
        <a href={`${basePath}campaigns`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">Current Campaigns</a>
        <a href={`${basePath}ai-alignment`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">AI Alignment for OSS</a>
        <a href="https://discord.gg/9BY9P5FD" target="_blank" rel="noopener noreferrer" class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">Join the Community</a>
        <div class="border-t border-gray-200 my-2"></div>
        <a href={`${basePath}about-us`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">About Us</a>
        <a href={`${basePath}faq`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">FAQ</a>
        <div class="border-t border-gray-200 my-2"></div>
        {user ? (
          <a href={`${basePath}api/auth/logout`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">
            Logout of {user.provider === 'github' ? 'GitHub' : user.provider === 'gitlab' ? 'GitLab' : user.provider || 'Account'}
          </a>
        ) : (
          <a href={`${basePath}login`} class="wishlist-menu-item block px-4 py-2 text-gray-700 hover:bg-gradient-to-r hover:from-purple-500 hover:to-violet-700 hover:text-white focus:outline-none rounded min-h-[44px] flex items-center transition-all relative">Login</a>
        )}
      </div>
    </div>
  </nav>
</header>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu toggle
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', function() {
        const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
        mobileMenuButton.setAttribute('aria-expanded', (!isExpanded).toString());
        mobileMenu.classList.toggle('hidden');
      });
    }
    
    // Dropdown IDs
    const dropdowns = [
      { id: 'wishlists', button: 'wishlists-dropdown-button', menu: 'wishlists-menu', container: 'wishlists-dropdown' },
      { id: 'helper-community', button: 'helper-community-dropdown-button', menu: 'helper-community-menu', container: 'helper-community-dropdown' },
      { id: 'about', button: 'about-dropdown-button', menu: 'about-menu', container: 'about-dropdown' }
    ];
    
    // Initialize each dropdown
    dropdowns.forEach(dropdown => {
      const button = document.getElementById(dropdown.button);
      const menu = document.getElementById(dropdown.menu);
      const container = document.getElementById(dropdown.container);
      
      if (button && menu && container) {
        // Toggle dropdown
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const icon = button.querySelector('svg');
          const isHidden = menu.classList.contains('hidden');
          
          // Close all other dropdowns
          dropdowns.forEach(other => {
            if (other.id !== dropdown.id) {
              const otherMenu = document.getElementById(other.menu);
              const otherButton = document.getElementById(other.button);
              const otherIcon = otherButton?.querySelector('svg');
              if (otherMenu) {
                otherMenu.classList.add('hidden');
                otherButton?.setAttribute('aria-expanded', 'false');
                if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
              }
            }
          });
          
          // Toggle current dropdown
          if (isHidden) {
            menu.classList.remove('hidden');
            button.setAttribute('aria-expanded', 'true');
            if (icon) icon.style.transform = 'rotate(180deg)';
            const firstItem = menu.querySelector('a');
            if (firstItem) firstItem.focus();
          } else {
            menu.classList.add('hidden');
            button.setAttribute('aria-expanded', 'false');
            if (icon) icon.style.transform = 'rotate(0deg)';
          }
        });
        
        // Keyboard navigation for dropdown button
        button.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            button.click();
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (menu.classList.contains('hidden')) {
              button.click();
            }
          }
        });
        
        // Keyboard navigation for menu items
        const menuItems = menu.querySelectorAll('a');
        menuItems.forEach((item, index) => {
          item.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              e.preventDefault();
              menu.classList.add('hidden');
              button.setAttribute('aria-expanded', 'false');
              const icon = button.querySelector('svg');
              if (icon) icon.style.transform = 'rotate(0deg)';
              button.focus();
            } else if (e.key === 'ArrowDown') {
              e.preventDefault();
              const nextItem = menuItems[index + 1];
              if (nextItem) nextItem.focus();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              if (index === 0) {
                button.focus();
              } else {
                menuItems[index - 1].focus();
              }
            }
          });
        });
      }
    });
    
    // Close all dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      dropdowns.forEach(dropdown => {
        const container = document.getElementById(dropdown.container);
        const menu = document.getElementById(dropdown.menu);
        const button = document.getElementById(dropdown.button);
        
        if (container && menu && !container.contains(event.target)) {
          menu.classList.add('hidden');
          button?.setAttribute('aria-expanded', 'false');
          const icon = button?.querySelector('svg');
          if (icon) icon.style.transform = 'rotate(0deg)';
        }
      });
    });
    
    // Close dropdowns and mobile menu when pressing Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        dropdowns.forEach(dropdown => {
          const menu = document.getElementById(dropdown.menu);
          const button = document.getElementById(dropdown.button);
          if (menu) {
            menu.classList.add('hidden');
            button?.setAttribute('aria-expanded', 'false');
            const icon = button?.querySelector('svg');
            if (icon) icon.style.transform = 'rotate(0deg)';
          }
        });
        
        if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          if (mobileMenuButton) {
            mobileMenuButton.setAttribute('aria-expanded', 'false');
            mobileMenuButton.focus();
          }
        }
      }
    });
    
  });
</script>